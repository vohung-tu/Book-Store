<p-toast></p-toast>

<div class="st-card">
  <h2>Phiếu chuyển hàng (Kho → Cửa hàng)</h2>

  <form [formGroup]="form" class="st-form">
    <div class="st-grid">
      <div class="st-field">
        <label>Ngày</label>
        <p-calendar formControlName="date" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
      </div>

      <div class="st-field">
        <label>Kho xuất</label>
        <p-dropdown
          formControlName="fromWarehouse"
          [options]="warehouses"
          optionLabel="name"
          optionValue="_id"
          placeholder="Chọn kho">
        </p-dropdown>
      </div>

      <div class="st-field">
        <label>Cửa hàng nhận</label>
        <p-dropdown
          formControlName="toStore"
          [options]="storeBranches"
          optionLabel="name"
          optionValue="_id"
          placeholder="Chọn cửa hàng">
        </p-dropdown>
      </div>

      <div class="st-field st-field--full">
        <label>Ghi chú</label>
        <input class="st-input" type="text" formControlName="note" placeholder="Ghi chú (nếu có)"/>
      </div>
    </div>

    <h3 class="st-subtitle">Dòng hàng</h3>
    <div class="st-table-wrap">
    <table class="st-table">
        <thead>
        <tr>
            <th style="width:40%">Sách</th>
            <th style="width:15%">Số lượng</th>
            <th style="width:20%">Đơn giá</th>
            <th style="width:20%">Thành tiền</th>
            <th style="width:5%"></th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let g of items.controls; let i = index" [formGroup]="$any(g)">
            <td>
           <p-dropdown
              formControlName="bookId"
              [options]="books"
              optionLabel="title"
              optionValue="_id"
              [filter]="true"
              placeholder="Chọn sách"
              filterPlaceholder="Gõ tên sách..."
              (onFilter)="searchBooks($event.filter)"
              (onChange)="updatePrice(i)">
            </p-dropdown>
            </td>
            <td>
            <p-inputNumber
                formControlName="quantity"
                [min]="1"
                [useGrouping]="false"
                (onInput)="updateSubtotal(i)">
            </p-inputNumber>
            </td>
            <td>
            <p-inputNumber
                formControlName="unitPrice"
                [min]="0"
                [useGrouping]="false"
                mode="currency"
                currency="VND"
                locale="vi-VN"
                (onInput)="updateSubtotal(i)">
            </p-inputNumber>
            </td>
            <td class="text-right">
            {{ g.value.subtotal | number:'1.0-0' }} ₫
            </td>
            <td>
            <button
                pButton
                type="button"
                icon="pi pi-trash"
                class="p-button-text p-button-danger"
                (click)="removeLine(i)"
                *ngIf="items.length > 1">
            </button>
            </td>
        </tr>
        </tbody>
    </table>
    </div>

    <div class="st-actions">
      <button pButton type="button" label="Thêm dòng" icon="pi pi-plus" (click)="addLine()"></button>
      <div class="st-total">
          <strong>Tổng cộng: </strong>
          {{ totalAmount | number:'1.0-0' }} ₫
      </div>

      <button
        pButton
        label="Lưu lại"
        icon="pi pi-save"
        class="p-button-success"
        (click)="submit()"
        [disabled]="loading()">
      </button>
    </div>
  </form>
</div>

<div class="st-card">
  <h2>Danh sách phiếu chuyển gần đây</h2>

  <div class="st-filter-bar" style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input
        type="text"
        pInputText
        placeholder="Tìm kiếm..."
        [(ngModel)]="filterText"
        (input)="applyFilter()"
        style="width: 250px"
      />
    </span>
  </div>

  <p-table [value]="filteredTransfers" [responsiveLayout]="'scroll'">
    <ng-template pTemplate="header">
      <tr>
        <th>Mã phiếu</th>
        <th>Ngày</th>
        <th>Kho xuất</th>
        <th>Cửa hàng nhận</th>
        <th>Số dòng</th>
        <th>Ghi chú</th>
        <th>Hành động</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td>{{ row.code }}</td>
        <td>{{ row.date | date:'short' }}</td>
        <td>{{ row.fromWarehouse?.name || '—' }} ({{ row.fromWarehouse?.region || '' }})</td>
        <td>{{ row.toStore?.name || '—' }} ({{ row.toStore?.city || '' }})</td>
        <td>{{ row.items?.length || 0 }}</td>
        <td>{{ row.note || '—' }}</td>
        <td>
          <button pButton label="Xem" icon="pi pi-eye" (click)="viewDetail(row)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog header="Chi tiết phiếu chuyển" [(visible)]="displayDetail" [style]="{width:'700px'}">
  <div *ngIf="selectedTransfer">
    <p><b>Mã phiếu:</b> {{ selectedTransfer.code }}</p>
    <p><b>Kho:</b> {{ selectedTransfer.fromWarehouse?.name }}</p>
    <p><b>Cửa hàng:</b> {{ selectedTransfer.toStore?.name }}</p>
    <p><b>Ghi chú:</b> {{ selectedTransfer.note || '—' }}</p>

    <table class="inner-table">
      <thead>
        <tr>
          <th>Tên sách</th>
          <th>Số lượng</th>
          <th>Đơn giá</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let i of selectedTransfer.items">
          <td>{{ getBookTitle(i.bookId) }}</td>
          <td>{{ i.quantity }}</td>
          <td>{{ i.unitPrice | number:'1.0-0' }}₫</td>
          <td>{{ i.quantity * i.unitPrice | number:'1.0-0' }}₫</td>
        </tr>
      </tbody>
    </table>
  </div>
</p-dialog>

