<div class="admin-coupons">
  <div class="header">
    <h2>Quản lý Coupon</h2>
  </div>

  <div class="body-bar">
    <button pButton label="Thêm Coupon" icon="pi pi-plus" (click)="openDialog()"></button>
  </div>

  <p-table [value]="coupons" [paginator]="true" [rows]="10">
    <ng-template pTemplate="header">
      <tr>
        <th>Mã</th>
        <th>Tiêu đề</th>
        <th>Mô tả</th>
        <th>Ngành hàng áp dụng</th>
        <th>Điều kiện áp dụng</th>
        <th>Loại</th>
        <th>Giá trị</th>
        <th>Đơn tối thiểu</th>
        <th>Ngày hiệu lực</th>
        <th>Cấp độ yêu cầu</th> 
        <th>Trạng thái</th>
        <th>Thao tác</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-c>
      <tr>
        <td>{{ c.code }}</td>
        <td>{{ c.title }}</td>
        <td>{{ c.description }}</td>
        <td>
          <span *ngIf="c.categories?.length; else noCategory">
            {{ c.categories.join(', ') }}
          </span>
          <ng-template #noCategory>
            <em>Áp dụng toàn bộ</em>
          </ng-template>
        </td>
        <td>{{ c.condition }}</td>
        <td>{{ c.type === 'percent' ? 'Giảm %' : 'Giảm tiền' }}</td>
        <td>{{ c.value }}{{ c.type === 'percent' ? '%' : '₫' }}</td>
        <td>{{ c.minOrder | number }}₫</td>
        <td>{{ c.startDate | date }} - {{ c.endDate | date }}</td>
        <td>
          <ng-container *ngIf="c.requiredLevel?.length; else allLevels">
            <p-tag 
              *ngFor="let lvl of c.requiredLevel" 
              [value]="getLevelName(lvl)" 
              [severity]="getLevelSeverity(lvl)"
            >
            </p-tag>
          </ng-container>
          <ng-template #allLevels>
            <em>Tất cả thành viên</em>
          </ng-template>
        </td>
        <td><p-tag [value]="c.status" [severity]="c.status==='active'?'success':'danger'"></p-tag></td>
        <td class="actions">
          <button pButton text icon="pi pi-pencil" (click)="editCoupon(c)"></button>
          <button pButton text icon="pi pi-trash" severity="danger" (click)="deleteCoupon(c._id!)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog [(visible)]="displayDialog" header="{{ isEdit ? 'Sửa Coupon' : 'Thêm Coupon' }}">
    <form (ngSubmit)="saveCoupon()">
      <div class="p-fluid">
        <!-- Các field cũ giữ nguyên -->
        <div class="p-field">
          <label>Mã CODE</label>
          <input pInputText type="text" [(ngModel)]="selectedCoupon.code" name="code" required />
        </div>

        <div class="p-field">
          <label>Tiêu đề</label>
          <input pInputText type="text" [(ngModel)]="selectedCoupon.title" name="title" required />
        </div>

        <div class="p-field">
          <label>Mô tả</label>
          <textarea pInputTextarea rows="3" [(ngModel)]="selectedCoupon.description" name="description"></textarea>
        </div>

        <div class="p-field">
          <label>Loại</label>
          <p-dropdown [options]="typeOptions" [(ngModel)]="selectedCoupon.type" name="type"></p-dropdown>
        </div>

        <div class="p-field">
          <label>Giá trị</label>
          <input type="number" pInputText [(ngModel)]="selectedCoupon.value" name="value" required />
        </div>

        <div class="p-field">
          <label>Đơn tối thiểu</label>
          <input type="number" pInputText [(ngModel)]="selectedCoupon.minOrder" name="minOrder" />
        </div>

        <div class="p-field">
          <label>Ngày bắt đầu</label>
          <p-calendar [(ngModel)]="selectedCoupon.startDate" name="startDate" dateFormat="yy-mm-dd"></p-calendar>
        </div>

        <div class="p-field">
          <label>Ngày kết thúc</label>
          <p-calendar [(ngModel)]="selectedCoupon.endDate" name="endDate" dateFormat="yy-mm-dd"></p-calendar>
        </div>

        <div class="p-field">
          <label>Ngành hàng áp dụng</label>
          <p-multiSelect
            [options]="categoryOptions"
            [(ngModel)]="selectedCoupon.categories"
            name="categories"
            optionLabel="label"
            optionValue="value"
            defaultLabel="Chọn danh mục"
            display="chip">
          </p-multiSelect>
        </div>

        <div class="p-field">
          <label>Điều kiện sử dụng</label>
          <textarea pInputTextarea rows="3" [(ngModel)]="selectedCoupon.condition" name="condition"></textarea>
        </div>

        <!-- ✅ Thêm dropdown chọn cấp độ yêu cầu -->
        <div class="p-field">
          <label>Cấp độ yêu cầu</label>
          <p-multiSelect 
            [options]="levelOptions" 
            [(ngModel)]="selectedCoupon.requiredLevel" 
            name="requiredLevel"
            defaultLabel="Chọn cấp độ"
            optionLabel="label" 
            optionValue="value"
            display="chip">
          </p-multiSelect>
        </div>
      </div>

      <div class="dialog-actions">
        <button pButton (click)="displayDialog = false" label="Hủy"></button>
        <button pButton type="submit" label="Lưu"></button>
      </div>
    </form>
  </p-dialog>
</div>
