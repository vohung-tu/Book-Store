<div class="inv-list-card">
  <h2 class="inv-list-title">Qu·∫£n l√Ω phi·∫øu xu·∫•t/nh·∫≠p kho</h2>

  <!-- üîç B·ªô l·ªçc -->
  <div class="inv-filters">
    <div class="inv-field">
      <label class="inv-label">Lo·∫°i phi·∫øu</label>
      <select class="inv-select" [(ngModel)]="type" (change)="page=1;load()">
        <option value="">T·∫•t c·∫£</option>
        <option value="import">Nh·∫≠p kho</option>
        <option value="export">Xu·∫•t kho</option>
      </select>
    </div>

    <div class="inv-field">
      <label class="inv-label">T·ª´ ng√†y</label>
      <p-calendar
        [(ngModel)]="from"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        appendTo="body"
        (onSelect)="page=1;load()">
      </p-calendar>
    </div>

    <div class="inv-field">
      <label class="inv-label">ƒê·∫øn ng√†y</label>
      <p-calendar
        [(ngModel)]="to"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        appendTo="body"
        (onSelect)="page=1;load()">
      </p-calendar>
    </div>

    <div class="inv-field inv-field--wide">
      <label class="inv-label">T√¨m ki·∫øm</label>
      <input
        class="inv-input"
        [(ngModel)]="q"
        placeholder="M√£ phi·∫øu / NCC / Ng∆∞·ªùi nh·∫≠n / Ghi ch√∫"
        (keyup.enter)="page=1;load()"/>
    </div>
  </div>

  <!-- üìã B·∫£ng danh s√°ch phi·∫øu -->
  <p-table
    [value]="items"
    [loading]="loading()"
    [paginator]="false"
    [rows]="limit"
    responsiveLayout="scroll"
    class="inv-p-table">

    <ng-template pTemplate="header">
      <tr>
        <th>M√£ phi·∫øu</th>
        <th>Lo·∫°i</th>
        <th>Ng√†y</th>
        <th>Chi nh√°nh</th>
        <th>Ghi ch√∫</th>
        <th>T·ªïng SL</th>
        <th>T·ªïng ti·ªÅn</th>
        <th></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td>{{ row.code }}</td>
        <td>
          <span
            class="inv-badge"
            [class.inv-badge--import]="row.type === 'import'"
            [class.inv-badge--export]="row.type === 'export'">
            {{ row.type === 'import' ? 'Nh·∫≠p' : 'Xu·∫•t' }}
          </span>
        </td>
        <td>{{ row.date | date:'short' }}</td>
        <td>{{ row.branchId?.name || '‚Äî' }}</td>  
        <td>{{ row.reason }}</td>
        <td>{{ row.totalQuantity }}</td>
        <td>{{ row.totalAmount | number }}</td>
        <td>
          <button
            pButton
            type="button"
            label="Chi ti·∫øt"
            (click)="openDetail(row)"
            class="btn-green"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Ph√¢n trang -->
  <p-paginator
    [rows]="limit"
    [totalRecords]="total"
    (onPageChange)="onPageChange($event)"
    [rowsPerPageOptions]="[10,20,50]">
  </p-paginator>
</div>

<!-- üìò Dialog chi ti·∫øt -->
<p-dialog
  [(visible)]="showDetail"
  [modal]="true"
  header="Chi ti·∫øt phi·∫øu"
  [style]="{width:'880px'}">

  <div *ngIf="selected as s">
    <div class="inv-detail-head">
      <b>{{ s.code }}</b> ‚Äî {{ s.type === 'import' ? 'Phi·∫øu nh·∫≠p' : 'Phi·∫øu xu·∫•t' }} ‚Äî {{ s.date | date:'short' }}
    </div>
    <div class="inv-detail-line" *ngIf="s.supplierName">Nh√† cung c·∫•p: <b>{{ s.supplierName }}</b></div>
    <div class="inv-detail-line" *ngIf="s.receiverName">Ng∆∞·ªùi nh·∫≠n: <b>{{ s.receiverName }}</b></div>
    <div class="inv-detail-line">Ghi ch√∫: {{ s.reason }}</div>

    <p-table [value]="s.details" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>S√°ch</th>
          <th>SL</th>
          <th>ƒê∆°n gi√°</th>
          <th>Th√†nh ti·ªÅn</th>
          <th>T·ªìn sau</th>
          <th>Chi nh√°nh c√≤n</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-d>
        <tr>
          <td>{{ d.bookId?.title }}</td>
          <td>{{ d.quantity }}</td>
          <td>{{ d.unitPrice | number }}</td>
          <td>{{ d.subtotal | number }}</td>
          <td>{{ d.bookId?.stockQuantity }}</td>
          <td class="inv-branch-stock">
            <div *ngIf="branchStocks[d.bookId?._id || d.bookId] as stocks; else loadingStock">
              <div *ngIf="stocks.length; else noStock">
                <small *ngFor="let st of stocks">
                  {{ st.branchName }}: <b>{{ st.quantity }}</b>
                </small>
              </div>
              <ng-template #noStock><small>Kh√¥ng c√≥ d·ªØ li·ªáu</small></ng-template>
            </div>
            <ng-template #loadingStock><i>ƒêang t·∫£i...</i></ng-template>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>
