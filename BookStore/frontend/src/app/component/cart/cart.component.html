<p-toast></p-toast>

<app-breadcrumb
  [items]="[
    { label: 'Trang chủ', url: '/' },
    { label: 'Giỏ hàng' }
  ]">
</app-breadcrumb>

<h1 style="text-align: center; color: #105191;">GIỎ HÀNG</h1>

<div class="cart-container" *ngIf="(cart$ | async) as cartData">
  <div class="cart-flex">
    <!-- ✅ TABLE GIỎ HÀNG (chỉ hiện nếu có sản phẩm) -->
    <div class="cart-table" *ngIf="cartData.length > 0; else emptyCart">
      <div class="delete-container" *ngIf="selectedBooks.length > 0">
        <p-button variant="outlined" severity="danger" label="XÓA TẤT CẢ" (click)="removeAllSelected()"></p-button>
        <p-button variant="outlined" severity="success" label="BỎ CHỌN TẤT CẢ" (click)="deselectAll()"></p-button>
      </div>

      <p-table
        [value]="cartData"
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5, 10, 20]"
        [(selection)]="selectedBooks"
        dataKey="_id"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem">
              <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
            </th>
            <th>Sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th>Xóa</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-book>
          <tr>
            <td><p-tableCheckbox [value]="book"></p-tableCheckbox></td>
            <td><img [src]="book.coverImage" class="product-img" /> {{ book.title }}</td>
            <td>{{ (book.flashsale_price || book.price) | dotSeparator }}đ</td>
            <td>
              <div class="quantity-wrapper">
                <button mat-button (click)="decreaseQuantity(book)">-</button>
                <span>{{ book.quantity || 1 }}</span>
                <button mat-button (click)="increaseQuantity(book)">+</button>
              </div>
            </td>
            <td class="total-price">
              {{ (book.flashsale_price || book.price) * (book.quantity || 1) | dotSeparator }}đ
            </td>
            <td>
              <button class="delete-btn" (click)="removeItem(book.cartItemId)">
                <i class="pi pi-trash"></i>
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- ✅ BÊN PHẢI: COUPON & TỔNG TIỀN -->
    <div class="cart-right">
      <!-- ✅ Luôn hiển thị coupon -->
      <div class="cart-coupons" *ngIf="savedCoupons.length > 0">
        <div class="coupon-header">
          <span class="title"><i class="pi pi-ticket"></i> KHUYẾN MÃI</span>
          <a class="view-more" (click)="toggleCouponView()">Xem thêm</a>
        </div>

        <div class="coupon-main" *ngFor="let c of displayedCoupons">
          <div class="coupon-info">
            <div class="coupon-title">{{ c.title }}</div>
            <div class="coupon-desc">{{ c.description }}</div>
            <div class="coupon-expiry">HSD: {{ c.endDate | date:'dd/MM/yyyy' }}</div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgress(c)"></div>
            </div>
          </div>

          <button class="btn-apply" [disabled]="isCouponDisabled(c)" (click)="applyCoupon(c)">
            {{ isCouponDisabled(c) ? 'Mua thêm' : 'Áp mã' }}
          </button>
        </div>

        <div class="applied-coupons" *ngIf="appliedCoupons.length > 0">
          <div class="coupon-tag" *ngFor="let ac of appliedCoupons">
            Mã {{ ac.code }}
            <span class="remove" (click)="removeAppliedCoupon(ac)">×</span>
          </div>
        </div>
      </div>

      <!-- ✅ Nếu có sản phẩm thì hiển thị tổng tiền -->
      <div class="cart-summary" *ngIf="cartData.length > 0">
        <div class="price-now">
          <h3>Tạm tính:</h3>
          <span>{{ originalTotal | dotSeparator }} đ</span>
        </div>

        <div class="discount" *ngIf="totalDiscount > 0">
          <h3>Giảm giá:</h3>
          <span>- {{ totalDiscount | dotSeparator }} đ</span>
        </div>

        <p-divider></p-divider>

        <div class="price-final">
          <h3>Tổng tiền:</h3>
          <span>{{ totalPrice | dotSeparator }} đ</span>
        </div>

        <p-button class="pay-btn" severity="success" label="THANH TOÁN" (click)="goToCheckout()"></p-button>
      </div>
    </div>
  </div>
</div>

<!-- ❌ KHI GIỎ HÀNG RỖNG -->
<ng-template #emptyCart>
  <div class="no-selected">
    <p>Không có sản phẩm nào được thêm vào giỏ hàng.  
    Quay lại <a href="/">cửa hàng</a> để tiếp tục mua sắm</p>
  </div>
</ng-template>

<!-- DIALOG HIỂN THỊ DANH SÁCH COUPON -->
<p-dialog
  header="CHỌN MÃ KHUYẾN MÃI"
  [(visible)]="couponDialogVisible"
  [modal]="true"
  [style]="{ width: '500px' }"
  [dismissableMask]="true"
  [breakpoints]="{ '960px': '95vw', '640px': '100vw' }">

  <div class="coupon-list">
    <div class="coupon-item" *ngFor="let c of savedCoupons">
      <div class="coupon-left">
        <div class="coupon-icon">
          <i class="pi" [ngClass]="c.type === 'percent' ? 'pi-percentage' : 'pi-ticket'"></i>
          <span>Mã giảm</span>
        </div>
      </div>

      <div class="coupon-right">
        <div class="coupon-title">{{ c.title }}</div>
        <div class="coupon-desc">{{ c.description }}</div>
        <div class="coupon-expiry">HSD: {{ c.endDate | date:'dd/MM/yyyy' }}</div>

        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgress(c)"></div>
        </div>

        <button class="btn-apply" [disabled]="isCouponDisabled(c)" (click)="applyCoupon(c)">
          {{ isCouponDisabled(c) ? 'Mua thêm' : 'Áp dụng' }}
        </button>
      </div>
    </div>
  </div>
</p-dialog>
<!-- Gợi ý mua kèm -->
<div class="ai-recommendation-books">
  <div class="ai-recommendation-title">
    <h1><i class="pi pi-shopping-cart"></i> Gợi ý mua kèm</h1>
  </div>

  <div class="ai-recommendation-body">
    <!-- Skeleton khi đang load -->
    <div *ngIf="isLoadingRecommended" class="skeleton-container">
      <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5]"></div>
    </div>

    <!-- Carousel khi có data -->
    <p-carousel 
      *ngIf="!isLoadingRecommended && recommendedBooks.length > 0"
      [value]="recommendedBooks"
      [numVisible]="5"
      [numScroll]="5"
      [circular]="false"
      [responsiveOptions]="responsiveOptions"
      styleClass="recommend-carousel">
      <ng-template let-book pTemplate="item">
        <app-product-item 
          [book]="book"
          (showToast)="handleToast($event)">
        </app-product-item>
      </ng-template>
    </p-carousel>

    <p *ngIf="!isLoadingRecommended && recommendedBooks.length === 0" style="text-align: center;">
      Hiện chưa có gợi ý nào phù hợp để mua kèm.
    </p>
  </div>
</div>
