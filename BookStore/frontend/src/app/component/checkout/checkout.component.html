<app-breadcrumb
  [items]="[
    { label: 'Trang chủ', url: '/' },
    { label: 'Giỏ hàng' , url: '/cart'},
    { label: 'Thanh toán'}
  ]">
</app-breadcrumb>

<h1 class="text-center text-black">THANH TOÁN</h1>

<!-- Hiển thị danh sách sản phẩm được chọn -->
<div class="checkout-container" *ngIf="selectedBooks.length > 0">
  <p-table [value]="selectedBooks" [paginator]="true" [rows]="5">
    <ng-template pTemplate="header">
      <tr>
        <th style="text-align: center;">Sản phẩm</th>
        <th style="width: 120px; text-align: center">Giá</th>
        <th style="width: 110px; text-align: center;">Số lượng</th>
        <th style="width: 120px; text-align: center;">Thành tiền</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-book>
      <tr>
        <td>
          <img [src]="book.coverImage" alt="product" class="product-img" />
          {{ book.title }}
        </td>
        <td>{{ (book.flashsale_price || book.price) | dotSeparator }} đ</td>
        <td style="text-align: center;">{{ book.quantity || 1 }}</td>
        <td class="total-price">
          {{ (book.flashsale_price || book.price) * (book.quantity || 1) | dotSeparator }} đ
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Form nhập thông tin giao hàng -->
  <div class="payment-info">
    <div class="shipping-info">
      <h3>Thông tin nhận hàng</h3>
      <form (ngSubmit)="submitOrder()" class="checkout-form">
        <!-- Họ và tên -->
        <label for="name">Họ và tên:</label>
        <input id="name" type="text" [(ngModel)]="orderInfo.name" name="name" required />

        <label for="email">Email:</label>
        <input id="email" type="email" [(ngModel)]="orderInfo.email" name="email" required [disabled]="true" [ngModelOptions]="{standalone: true}" />

        <label for="phone">Số điện thoại:</label>
        <input id="phone" type="tel" [(ngModel)]="orderInfo.phone" name="phone" required />

        <label for="addresses">Sổ địa chỉ:</label>
        <p-dropdown
          [options]="addresses"
          [(ngModel)]="selectedAddress"
          name="selectedAddress"
          optionLabel="label"
          optionValue="value"
          placeholder="Chọn địa chỉ"
          (onChange)="onAddressChange($event)"
          [ngModelOptions]="{standalone: true}"
        ></p-dropdown>

        <!-- Ô nhập địa chỉ khác -->
        <label for="address">Địa chỉ:</label>
        <input
          id="address"
          type="text"
          [(ngModel)]="orderInfo.address"
          name="address"
          required
          placeholder="Chọn địa chỉ hoặc nhập địa chỉ khác"
          (input)="onAddressInput()"
        />

        <div class="add-address">
          <label for="cities">Tỉnh thành:</label>
          <p-dropdown 
            [options]="cities" 
            [(ngModel)]="selectedCity" 
            [ngModelOptions]="{standalone: true}" 
            optionLabel="Name" placeholder="Tỉnh Thành" class="w-full md:w-56" (onChange)="onCityChange()" />
        </div>
        <div class="add-address">
          <label for="districts">Quận huyện:</label>
          <p-dropdown [options]="districts" [(ngModel)]="selectedDistrict" [ngModelOptions]="{standalone: true}" optionLabel="Name" placeholder="Quận Huyện" class="w-full md:w-56" (onChange)="onDistrictChange()" />
        </div>
        <div class="add-address">
          <label for="wards">Phường xã:</label>
          <p-dropdown [options]="wards" [(ngModel)]="selectedWard" [ngModelOptions]="{standalone: true}" optionLabel="Name" placeholder="Phường Xã" class="w-full md:w-56" />
        </div>

        <label for="note">Ghi chú (tùy chọn):</label>
        <textarea id="note" rows="5" [(ngModel)]="orderInfo.note" name="note"></textarea>
      </form>
    </div>

    <!-- Phương thức thanh toán -->
    <div class="payment-method">
      <h3>Vận chuyển</h3>
      <div class="shipping-option">
        <p-radiobutton 
          name="shipping" 
          value="other_provinces" 
          [(ngModel)]="shipping.selected" 
          inputId="otherProvinces">
        </p-radiobutton>
      
        <label for="otherProvinces" class="shipping-label">
          Các tỉnh thành (2-4 ngày)
        </label>
      
        <span class="shipping-price">25.000 VND</span>
      </div>
      
      <h3>Thanh toán</h3>
      <div class="flex-1 flex-wrap gap-4">

        <!-- Bank -->
        <div class="flex items-center" style="display: flex;">
          <p-radiobutton
            name="payment"
            value="bank"
            [(ngModel)]="orderInfo.payment"
            inputId="payment1"
            (onClick)="onPaymentChange()"
          />
          <label for="payment1">Chuyển khoản qua ngân hàng</label>
        </div>
        <div *ngIf="orderInfo.payment === 'bank'" class="ml-6">
          <p><strong>Thông tin chuyển khoản:</strong></p>
          <p>Ngân hàng: NCB</p>
          <p>Số tài khoản: 9704198526191432198</p>
          <p>Chủ tài khoản: Nguyễn Văn A</p>
          <p>Nội dung chuyển khoản: [Mã đơn hàng]</p>
        </div>

        <!-- COD -->
        <div class="flex-1 items-center" style="display: flex;">
          <p-radiobutton
            name="payment"
            value="cod"
            [(ngModel)]="orderInfo.payment"
            inputId="payment2"
            (onClick)="onPaymentChange()"
          />
          <label for="payment2">Thanh toán khi nhận hàng (COD)</label>
        </div>

        <!-- MOMO -->
        <div class="flex-1 items-center" style="display: flex;">
          <p-radiobutton
            name="payment"
            value="momo"
            [(ngModel)]="orderInfo.payment"
            inputId="payment3"
            (onClick)="onPaymentChange()"
          />
          <div style="padding: 10px; display: flex;">
            
            <img src="assets/images/momo.png" alt="" width="32px" height="32px">
          <label for="payment3" style="padding-left: 10px;">
            Ví MoMo</label>
          </div>
        </div>
        <div *ngIf="orderInfo.payment === 'momo'" class="ml-6">
          <canvas #qrMomoCanvas></canvas>
          <p>Quét mã QR bằng ứng dụng MoMo để thanh toán.</p>
        </div>

        <!-- VNPAY -->
        <div class="flex-1 items-center" style="display: flex;">
          <p-radiobutton
            name="payment"
            value="vnpay"
            [(ngModel)]="orderInfo.payment"
            inputId="payment4"
            (onClick)="onPaymentChange()"
          />
          <div class="vnpay-class" style="padding: 10px; display: flex;">
            <img src="assets/images/vnpay.png" alt="" width="32px" height="32px">
            <label for="payment4" style="padding-left: 10px;"> VNPAY</label>
          </div>
        </div>

        <div *ngIf="orderInfo.payment === 'vnpay'" class="ml-6">
          <p>Nhấn nút bên dưới để thanh toán ngay qua VNPAY:</p>
          <button 
            pButton 
            type="button" 
            label="Thanh toán VNPAY" 
            icon="pi pi-credit-card" 
            class="p-button-danger"
            (click)="payWithVnpay()">
          </button>
        </div>
      </div>
     <!-- PHẦN HIỂN THỊ MÃ GIẢM GIÁ ĐÃ ÁP DỤNG -->
    <div class="applied-coupons" *ngIf="appliedCoupons.length">
      <h3><i class="pi pi-tags"></i> Mã giảm giá đã áp dụng</h3>
      <div class="coupon-tags">
        <span class="coupon-tag" *ngFor="let c of appliedCoupons">
          <i class="pi pi-ticket"></i> {{ c.code }}
          <span class="remove" (click)="removeCoupon(c)">
            <i class="pi pi-times"></i>
          </span>
        </span>
      </div>
    </div>

    <!-- TÓM TẮT GIÁ TRỊ THANH TOÁN -->
    <div class="price-summary">
      <div class="line">
        <strong>Tạm tính:</strong>
        <p>{{ totalAmount | dotSeparator }} đ</p>
      </div>

      <div class="line discount" *ngIf="totalDiscount > 0">
        <strong>Giảm giá:</strong>
        <p>- {{ totalDiscount | dotSeparator }} đ</p>
      </div>

      <div class="line">
        <strong>Phí vận chuyển:</strong>
        <p>{{ shippingFee | dotSeparator }} đ</p>
      </div>

      <p-divider></p-divider>

      <div class="line total">
        <strong>Tổng thanh toán:</strong>
        <p class="final-price">{{ (discountedAmount + shippingFee) | dotSeparator }} đ</p>
      </div>

      <button
        type="button"
        class="pay-btn"
        [disabled]="!canSubmitOrder"
        (click)="submitOrder()"
      >
        <strong>ĐẶT HÀNG</strong>
      </button>
    </div>
    </div>
  </div>
</div>

<!-- Nếu không có sản phẩm nào -->
<div *ngIf="selectedBooks.length === 0" class="no-items">
  <p>Không có sản phẩm nào để thanh toán. Quay lại <a routerLink="/cart">giỏ hàng</a>.</p>
</div>  