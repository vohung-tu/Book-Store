<div class="book-cover" *ngIf="books">
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <div class="book-details-row">
    
    <div class="book-detail-1">
      <div class="book-detail-left">
      <!-- ·∫¢nh ch√≠nh -->
        <img [src]="currentCoverImage || books.coverImage" [alt]="books.title" class="cover-img" />

        <!-- ·∫¢nh ph·ª• -->
        <div class="book-sub-images" *ngIf="books?.images?.length">
          <!-- Hi·ªÉn th·ªã 3 ·∫£nh ƒë·∫ßu ti√™n -->
           <ng-container *ngFor="let img of (books?.images ?? []).slice(0, 3)">
            <img 
              [src]="img" 
              alt="·∫¢nh ph·ª• s√°ch" 
              class="sub-image" 
              (click)="changeCover(img)" 
            />
          </ng-container>

          <!-- N·∫øu c√≥ ƒë√∫ng 4 ·∫£nh -->

          <ng-container *ngIf="books?.images as imgs">
            <ng-container *ngIf="imgs.length === 4">
              <img 
                [src]="books.images?.[3]!" 
                alt="·∫¢nh ph·ª• s√°ch" 
                class="sub-image" 
                (click)="changeCover(books.images?.[3]!)" 
              />
            </ng-container>
          </ng-container>

          <!-- N·∫øu c√≥ nhi·ªÅu h∆°n 4 ·∫£nh, hi·ªÉn th·ªã ·∫£nh th·ª© 4 v·ªõi l·ªõp ph·ªß -->
          <ng-container *ngIf="books?.images as imgs">
            <ng-container *ngIf="imgs.length > 4">
              <!-- N·ªôi dung khi c√≥ h∆°n 4 ·∫£nh -->
              <div class="sub-image overlay" (click)="changeCover(books.images?.[3]!)"
              [style.backgroundImage]="'url(' + books.images?.[3]! + ')'">
                <img 
                    [src]="books.images?.[3]!" 
                    alt="·∫¢nh ph·ª• s√°ch" 
                    class="sub-image-overlay-img"
                  />
                <div class="overlay-text" *ngIf="books?.images as imgs">+{{ imgs.length - 3 }}</div>
              </div>
            </ng-container>
          </ng-container>
        </div>

      </div>

      <div class="book-detail-right">
        <h2>{{ books.title }}</h2>

        <div class="book-info">
          <h4 class="price">{{ books.flashsale_price | dotSeparator }} ƒë</h4>

          <div class="discount">
            <h5>{{ books.price | dotSeparator }} ƒë</h5>
            <div class="discount-badge">-{{ books.discount_percent }}%</div>
          </div>
          <td style="display: flex;">
            <b>T√°c gi·∫£: &nbsp;</b>
            <a *ngIf="product?.author?._id" 
              [routerLink]="['/author', product?.author?._id]"
              class="author-href" style="text-decoration: none; color: #105191">
              {{ product?.author?.name || 'Kh√¥ng r√µ' }}
            </a>
            <span *ngIf="!product?.author?._id">
              {{ product?.author?.name || 'Kh√¥ng r√µ' }}
            </span>
          </td>
          <p *ngIf="books.supplierId">
            <strong>Nh√† cung c·∫•p:</strong>
            <span style="margin-left: 4px;">
              {{ books.supplierId.name || 'Kh√¥ng r√µ' }}

            </span>
          </p>
          <span *ngIf="!book.author?.name">Kh√¥ng r√µ</span>
          <p><strong>NƒÉm xu·∫•t b·∫£n:</strong> {{ books.publishedDate | date:'dd/MM/yyyy' }}</p>

          <div class="branch-chip-container" *ngIf="branchStocks.length > 0">
            <strong>Khu v·ª±c kho:</strong>

            <!-- Chip ‚ÄúT·∫•t c·∫£‚Äù -->
            <div
              class="branch-chip"
              [class.active]="selectedBranch === 'ALL'"
              (click)="selectBranch('ALL')">
              T·∫•t c·∫£
            </div>

            <!-- Chip c√°c chi nh√°nh -->
            <div
              *ngFor="let branch of branchStocks"
              class="branch-chip"
              [class.active]="selectedBranch === branch.branchName"
              (click)="selectBranch(branch.branchName)">
              {{ branch.branchName }}
            </div>
          </div>

          <!-- Hi·ªÉn th·ªã t·ªìn kho -->
          <div class="branch-stock-info" *ngIf="selectedBranchStock">
            <p>
              <strong>T·ªìn kho t·∫°i {{ selectedBranch === 'ALL' ? 't·∫•t c·∫£ kho' : selectedBranchStock.branchName }}:</strong>
              {{ selectedBranchStock.quantity > 0 ? selectedBranchStock.quantity + ' s·∫£n ph·∫©m' : 'H·∫øt h√†ng' }}
            </p>
          </div>
        </div>

        <!-- N√∫t mua s√°ch -->
        <div class="purchase-buttons">
          <p-toast position="top-right" key="tr"></p-toast>
          <button 
            pButton 
            class="green-btn" 
            pRipple 
            [rounded]="true" 
            (click)="addToCart()"
            [disabled]="!books.quantity || books.quantity === 0" 
            [label]="books.quantity && books.quantity > 0 ? 'Th√™m v√†o gi·ªè h√†ng' : 'H·∫øt h√†ng'"
          ></button>
          
          <p-button 
            [icon]="isFavorite ? 'pi pi-heart-fill' : 'pi pi-heart'" 
            (click)="toggleFavorite()" 
            [rounded]="true" 
            [text]="true" 
            [raised]="true" 
            severity="success">
          </p-button>
        </div>

        <div class="address-shipping">
          <div class="shipping-time" (click)="openAddressDialog()">
            <i class="pi pi-map"></i>
            <p style="margin-left: 8px;">
              <a href="javascript:void(0)">
                {{ selectedAddress ? ('Giao ƒë·∫øn: ' + selectedAddress.full) : 'Ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng ƒë·ªÉ bi·∫øt th·ªùi gian giao' }}
              </a>
            </p>
          </div>

          <div *ngIf="selectedAddress" class="shipping-info">
            <p><strong>Giao ti·∫øt ki·ªám:</strong> {{ deliveryTime }} ‚Äî 
              <span class="freeship">{{ shippingFee === 0 ? 'Mi·ªÖn ph√≠' : (shippingFee | currency:'VND') }}</span>
            </p>
          </div>
        </div>

        <!-- üìç Dialog ch·ªçn ƒë·ªãa ch·ªâ -->
        <p-dialog header="Ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng"
                  [(visible)]="showAddressDialog"
                  [modal]="true"
                  [style]="{ width: '600px' }">

          <div class="address-dialog">
            <input pInputText type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ (T·ªânh, Qu·∫≠n, Ph∆∞·ªùng...)" 
                  [(ngModel)]="addressSearch" (input)="filterAddresses()"
                  class="address-search"/>

            <p *ngIf="filteredAddresses.length === 0 && !addingNew">
              <i>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c l∆∞u.</i>
            </p>

            <!-- Danh s√°ch ƒë·ªãa ch·ªâ ƒë√£ l∆∞u -->
            <ul class="address-list" *ngIf="!addingNew">
              <li *ngFor="let addr of filteredAddresses" (click)="selectAddress(addr)" class="address-item">
                <div class="addr-text">
                  {{ addr.full }}
                </div>
                <span class="addr-action">Ch·ªçn</span>
              </li>
            </ul>

            <div class="divider">Ho·∫∑c</div>

            <button pButton label="Th√™m ƒë·ªãa ch·ªâ m·ªõi" icon="pi pi-plus" 
                    class="btn-add-address" 
                    (click)="addingNew = true" *ngIf="!addingNew"></button>

            <!-- Form th√™m m·ªõi -->
            <div *ngIf="addingNew" class="new-address-form">
              <input pInputText type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß..." [(ngModel)]="newAddress.full"/>
              <button pButton label="L∆∞u ƒë·ªãa ch·ªâ" (click)="saveNewAddress()"></button>
              <button pButton label="H·ªßy" class="p-button-text" (click)="addingNew = false"></button>
            </div>
          </div>
        </p-dialog>


        <div class="store-dialog">
          <div class="url-branch" (click)="showStoreDialog = true">
            <i class="pi pi-shop"></i>
            <p style="margin-left: 8px;">
              <a href="javascript:void(0)">Xem chi nh√°nh c√≥ h√†ng</a>
            </p>
          </div>
        </div>

        <p-dialog 
          header="Xem chi nh√°nh c√≥ h√†ng" 
          [(visible)]="showStoreDialog" 
          [modal]="true" 
          [style]="{ width: '700px', maxHeight: '80vh' }"
        >
          <div *ngIf="storeStocks?.length; else noStore" class="store-list">
            <p class="store-total">
              C√≥ {{ storeStocks.length }} chi nh√°nh c√≥ h√†ng
            </p>

            <ul class="store-ul">
              <li *ngFor="let s of storeStocks" class="store-item">
                <div class="store-info">
                  <div class="store-name">
                    <strong>{{ s.name }}</strong> - <p style="color: #000; display: contents;"> C√≤n {{ s.quantity }} s·∫£n ph·∫©m</p>
                  </div>
                  <div class="store-address">
                    {{ s.address }}, {{ s.city }}, {{ s.region }}
                  </div>
                  <div class="store-links">
                    <a 
                      *ngIf="s.mapUrl" 
                      [href]="s.mapUrl" 
                      target="_blank" 
                      rel="noopener noreferrer"
                    >
                      Xem b·∫£n ƒë·ªì
                    </a>
                    <span *ngIf="s.quantity > 0" class="store-action" (click)="orderFromStore(s)">
                      C√≥ h√†ng, ƒë·∫∑t h√†ng t·∫°i ƒë√¢y
                    </span>
                    <span *ngIf="!s.quantity || s.quantity === 0" class="store-out">
                      H·∫øt h√†ng
                    </span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <ng-template #noStore>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu chi nh√°nh c·ª≠a h√†ng.</p>
          </ng-template>
        </p-dialog>

      </div>
    </div>

    <div class="book-detail-2">
      <h3>M√¥ t·∫£ s·∫£n ph·∫©m</h3>
      <p class="detailed-description" [innerHTML]="books.description || 'Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt.'"></p>
      <div class="book-summary">
        <button 
          pButton 
          label="Xem th√™m t√≥m t·∫Øt AI" 
          icon="pi pi-sparkles" 
          (click)="toggleSummary()"
          class="summary-btn">
        </button>

        <div *ngIf="showSummary" class="summary-box">
          <h3>T√≥m t·∫Øt n·ªôi dung (AI)</h3>
          <p *ngIf="loadingSummary">‚è≥ ƒêang t·∫°o t√≥m t·∫Øt...</p>
          <p *ngIf="!loadingSummary && summary" [innerHTML]="formatSummary(summary)"></p>
          <p *ngIf="!loadingSummary && !summary" class="empty">
            Ch∆∞a c√≥ t√≥m t·∫Øt, vui l√≤ng b·∫•m n√∫t ƒë·ªÉ t·∫°o.
          </p>
          <a class="collapse-link" (click)="toggleSummary()">Thu g·ªçn ‚ñ≤</a>
        </div>
      </div>

    </div>

  <!-- Div 3: ƒê√°nh gi√° s·∫£n ph·∫©m -->
  <div class="book-detail-3">
    <h3>ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
    <div class="rating-summary">
      
      <div class="score">{{ averageRating }}<span>/5</span></div>
        <p-rating [readonly]="true" [stars]="5" [(ngModel)]="averageRating"></p-rating>
        <div class="rating-count">({{ reviews.length }} ƒë√°nh gi√°)</div>

      <div class="rating-breakdown" *ngIf="totalRatings > 0">
        <div class="rating-bar" *ngFor="let star of [5, 4, 3, 2, 1]">
          <span class="label">{{ star }} sao</span>
          <div class="bar">
            <div class="fill" [style.width.%]="getPercent(star)"></div>
          </div>
          <span class="percent">{{ getPercent(star) | number:'1.0-0' }}%</span>
        </div>
      </div>
  
      <!-- N√∫t m·ªü dialog -->
      <div class="review-button">
        <button pButton label="Vi·∫øt ƒë√°nh gi√°" icon="pi pi-pencil"
          class="p-button-outlined p-button-danger"
          (click)="showReviewDialog = true">
        </button>
      </div>

      <!-- Dialog ƒë√°nh gi√° -->
      <p-dialog header="VI·∫æT ƒê√ÅNH GI√Å S·∫¢N PH·∫®M" [(visible)]="showReviewDialog" [modal]="true" [style]="{ width: '800px' }"
      class="review-dialog">
        <ng-container *ngIf="authService.isLoggedIn(); else guestMessage">

          <div class="rating-dialog">
            <p-rating [(ngModel)]="review.rating"></p-rating>
          </div>

          <div class="review-input-name">
            <div class="p-field-name p-col-8">
              <input pInputText type="text" placeholder="Nh·∫≠p t√™n s·∫Ω hi·ªÉn th·ªã khi ƒë√°nh gi√°" [(ngModel)]="review.name" />
              <p-toggleButton [(ngModel)]="review.anonymous" onLabel="Anonymous" offLabel="Username"></p-toggleButton>
            </div>

          </div>
          <div class="p-field-comment">
            <textarea pTextarea rows="4" placeholder="Nh·∫≠p nh·∫≠n x√©t c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m" [(ngModel)]="review.comment" style="width: 100%; border-radius: 10px; height: 200px;"></textarea>
          </div>

          <div class="p-d-flex p-jc-between">
            <button pButton label="H·ªßy" class="p-button-text" (click)="showReviewDialog = false"></button>
            <button [disabled]="hasReviewed" pButton label="G·ª≠i nh·∫≠n x√©t" class="p-button-danger-outline" (click)="submitReview()"></button>
          </div>
        </ng-container>

        <ng-template #guestMessage>
          <div class="p-text-center" style="padding: 2rem;">
            <p class="text-danger">Ch·ªâ c√≥ th√†nh vi√™n m·ªõi c√≥ th·ªÉ vi·∫øt nh·∫≠n x√©t.</p>
            <a routerLink="/signin">ƒêƒÉng nh·∫≠p</a> ho·∫∑c <a routerLink="/signup">ƒêƒÉng k√Ω</a> ƒë·ªÉ ti·∫øp t·ª•c.
          </div>
        </ng-template>
      </p-dialog>

    </div>
    <div class="review-list">
      <p *ngIf="reviews.length === 0">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
      <div *ngFor="let r of reviews" class="review-item">
        <strong>{{ r.name }}</strong>
        <p-rating [(ngModel)]="r.rating" [readonly]="true"></p-rating>
        <p>{{ r.comment }}</p>
        <small>{{ r.createdAt | date:'short' }}</small>
        <hr />
        <!-- <div *ngIf="r.image">
          <img [src]="r.image" alt="·∫¢nh ƒë√°nh gi√°" style="max-width: 200px;" />
        </div> -->
      </div>
    </div>

  </div>

  <!-- Div 4: S·∫£n ph·∫©m li√™n quan -->
  <div class="book-detail-4" *ngIf="relatedBooks.length > 0">
    <h3>S·∫£n ph·∫©m li√™n quan</h3>
    <div class="related-products">
      <app-product-item
        *ngFor="let product of relatedBooks"
        [book]="product"
      ></app-product-item>
    </div>
  </div>
</div>


<!-- Khi ƒëang t·∫£i d·ªØ li·ªáu -->
<ng-template #loading>
  <p>ƒêang t·∫£i th√¥ng tin s√°ch...</p>
</ng-template>