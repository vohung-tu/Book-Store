<header class="header" >
  <div class="header__top">
    <div class="container">
      <div class="header__top__left">
        <div class="logo">
          <a routerLink="/home">
            <img src="assets/images/logo.png" alt="" width="180px" height="90px">
          </a>

          <!-- üîΩ N√∫t menu icon -->
        <div 
          class="menu-toggle"
          (mouseenter)="showMenu = true"
          (mouseleave)="showMenu = false">
          <i class="pi pi-bars"></i>
          <i class="pi pi-chevron-down"></i>

          <!-- Mega Menu -->
          <div class="mega-menu" *ngIf="showMenu">
            <div class="mega-menu__sidebar">
              <ul>
                <h3 style="text-align: center;">Danh m·ª•c s·∫£n ph·∫©m</h3>
                <li *ngFor="let cat of categories"
                  (mouseenter)="activeCategory = cat"
                  (click)="navigateToCategory(cat.slug, $event)"
                  [class.active]="activeCategory?._id === cat._id">
                  {{ cat.name }}
                </li>
              </ul>
            </div>
            <div class="mega-menu__content" *ngIf="activeCategory">
              <h4>{{ activeCategory.name }}</h4>
              <ng-container *ngIf="activeCategory.children?.length; else noChildren">
              <div class="submenu-column" *ngFor="let sub of activeCategory.children">
                <h5 (click)="navigateToCategory(sub.slug)">{{ sub.name }}</h5>
                <ul *ngIf="sub.children?.length">
                  <li *ngFor="let child of sub.children" (click)="navigateToCategory(child.slug)">
                    {{ child.name }}
                  </li>
                </ul>
              </div>
            </ng-container>

            <ng-template #noChildren>
              <p style="color: gray; font-style: italic;">Ch∆∞a c√≥ danh m·ª•c con</p>
            </ng-template>
            </div>
          </div>
        </div>
        
          <!-- search -->
          <div class="search-container" (clickOutside)="hideSuggestions()">
            <i class="pi pi-search search-icon"></i>
            <input
              type="text"
              class="search-input"
              placeholder="T√¨m ki·∫øm s√°ch b·∫°n c·∫ßn"
              [(ngModel)]="searchTerm"
              (input)="onInputChange()"
              (keydown.enter)="onSearch()"
            />

            <ul class="suggestions-dropdown" *ngIf="suggestions.length">
              <li *ngFor="let suggestion of suggestions" (click)="selectSuggestion(suggestion)">
                <i class="pi pi-search search-icon"></i> {{ suggestion.title }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="header__top__right">
        <div class="header__top__right__cart">

          <div class="noti-container" (click)="$event.stopPropagation()">
            <a
              class="bell-btn"
              mat-button
              (click)="toggleNotiDropdown($event)"
            >
              <i class="pi pi-bell"></i>
              <p-badge
                *ngIf="unreadCount > 0"
                [value]="unreadCount"
                severity="danger"
              ></p-badge>
            </a>

           <!-- DROPDOWN -->
            <div class="noti-dropdown" *ngIf="showNotiDropdown">
              <div class="noti-header">
                <span>Th√¥ng b√°o</span>
                <button
                  *ngIf="unreadCount > 0"
                  mat-button
                  class="mark-all-btn"
                  (click)="markAllAsRead($event)"
                >
                  ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                </button>
              </div>

              <div class="noti-body" *ngIf="!isLoadingNoti; else loadingTpl">
                <div *ngIf="notifications.length === 0" class="noti-empty">
                  Ch∆∞a c√≥ th√¥ng b√°o n√†o
                </div>

                <div
                  class="noti-item"
                  *ngFor="let noti of notifications"
                  (click)="onClickNotification(noti, $event)"
                  [class.unread]="!noti.isRead"
                >
                  <div class="noti-title">{{ noti.title }}</div>
                  <div class="noti-message">{{ noti.message }}</div>
                  <div class="noti-time">
                    {{ noti.createdAt | date: 'HH:mm dd/MM/yyyy' }}
                  </div>
                </div>
              </div>

              <!-- üîΩ FOOTER -->
              <div class="noti-footer">
                <a
                  style="color: #1368c2;"
                  class="view-all"
                  (click)="goToNotificationPage($event)"
                >
                  Xem t·∫•t c·∫£
                </a>
              </div>

              <ng-template #loadingTpl>
                <div class="noti-loading">
                  ƒêang t·∫£i th√¥ng b√°o...
                </div>
              </ng-template>
            </div>

          </div>

          <!-- CART -->
          <a routerLink="/cart" class="cart-btn" mat-button>
            <i class="pi pi-shopping-cart"></i>
            <p-badge
              *ngIf="cartItemCount > 0"
              [value]="cartItemCount"
              severity="danger"
            ></p-badge>
          </a>

          <!-- WISHLIST -->
          <a routerLink="/wishlist" class="cart-btn" mat-button>
            <i class="pi pi-heart-fill"></i>
          </a>
        </div>

        <a routerLink="/contact" mat-button style="color:#fff">Li√™n H·ªá</a>
        <div class="sign_up">
          <ng-container *ngIf="isLoading$ | async; else loadedState">
            <mat-spinner diameter="24"></mat-spinner> <!-- Spinner khi loading -->
          </ng-container>
        
          <ng-template #loadedState>
            <ng-container *ngIf="isLoggedIn$ | async; else notLoggedIn">
              <button mat-button [matMenuTriggerFor]="userMenu" *ngIf="currentUser" style="color: #fff;">
                <span style="display: flex; align-items: center; gap: 8px;">
                  <i class="pi pi-user"></i>
                  <p style="margin: 0; font-size: 14px;">Hi, {{ currentUser.username }}!</p>
                </span>
              </button>
              <mat-menu #userMenu="matMenu">
                <button mat-menu-item routerLink="/user-info">
                  <mat-icon>person</mat-icon> Th√¥ng tin c√° nh√¢n
                </button>

                <button mat-menu-item *ngIf="userRole === 'admin'" routerLink="/admin/dashboard" target="_blank">
                  <mat-icon>admin_panel_settings</mat-icon> Qu·∫£n tr·ªã
                </button>
                <button mat-menu-item (click)="signout()">
                  <mat-icon>logout</mat-icon> ƒêƒÉng xu·∫•t
                </button>
              </mat-menu>
            </ng-container>
        
            <ng-template #notLoggedIn>
              <button class="auth-button" mat-button routerLink="/signin">ƒêƒÉng Nh·∫≠p</button>
            </ng-template>
          </ng-template>
        </div>
      </div>

     <!-- üó∫Ô∏è ƒê·ªãa ch·ªâ giao h√†ng -->
      <div class="shipping-location" (click)="showLocationDialog()">
        <i class="pi pi-map-marker"></i>
        <span>Giao ƒë·∫øn: <u>{{ locationText || 'ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...' }}</u></span>
      </div>
      <!-- üß≠ Popup ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng -->
      <p-dialog 
        header="Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng"
        [(visible)]="locationDialogVisible"
        [modal]="true"
        [dismissableMask]="true"
        [style]="{ width: '420px' }"
      >
        <p>H√£y ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng ƒë·ªÉ ƒë∆∞·ª£c d·ª± b√°o th·ªùi gian giao h√†ng c√πng ph√≠ ƒë√≥ng g√≥i, v·∫≠n chuy·ªÉn m·ªôt c√°ch ch√≠nh x√°c nh·∫•t.</p>
        <div *ngIf="currentLocationAddr" class="address-item gps">
          <label>
            <input
              type="radio"
              name="address"
              [value]="{ value: currentLocationAddr, isDefault: false }"
              [(ngModel)]="selectedAddress"
            />
            <span>
              <b>V·ªã tr√≠ hi·ªán t·∫°i:</b> {{ currentLocationAddr }}
            </span>
          </label>
        </div>

        <hr *ngIf="currentLocationAddr && addressList?.length">

        <!-- üîπ Danh s√°ch ƒë·ªãa ch·ªâ t·ª´ database -->
        <div *ngIf="addressList?.length; else noAddress">
          <div class="address-list">
            <div class="address-item" *ngFor="let addr of addressList">
              <label>
                <input 
                  type="radio" 
                  name="address" 
                  [value]="addr" 
                  [(ngModel)]="selectedAddress"
                />
                <span>
                  {{ addr.value }}
                  <span *ngIf="addr.isDefault" class="default-tag">(M·∫∑c ƒë·ªãnh)</span>
                </span>
              </label>
            </div>
          </div>
        </div>

        <!-- üîπ N·∫øu kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o -->
        <ng-template #noAddress>
          <p>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng n√†o.</p>
        </ng-template>

        <!-- üîπ N√∫t x√°c nh·∫≠n -->
        <div class="dialog-footer">
          <button 
            pButton 
            label="GIAO ƒê·∫æN ƒê·ªäA CH·ªà N√ÄY" 
            class="confirm-btn"
            (click)="confirmAddress()"
          ></button>
        </div>
      </p-dialog>
    </div>
  </div>
</header>
<p-toast position="top-right"></p-toast>